<!doctype html>
<meta charset="utf-8">
<title>LoveBoat Project</title>
<body style="margin:0px;">
<script src="pixi.min.js"></script>
<script src="jquery.min.js"></script>
<script>
//Aliases
var Container = PIXI.Container,
    autoDetectRenderer = PIXI.autoDetectRenderer,
    loader = PIXI.loader,
    resources = PIXI.loader.resources,
    TextureCache = PIXI.utils.TextureCache,
    Sprite = PIXI.Sprite;
    Texture = PIXI.Texture;

var zoneProportion = 2000 / 800;
var renderer = autoDetectRenderer(2000, 800);
document.body.appendChild(renderer.view);
var stage = new Container();
renderer.backgroundColor = 0xF2BDD0;
renderer.render(stage);

$( window ).ready(function() {
  renderer.view.style.width = $( window ).width()+"px";
  renderer.view.style.height = $( window ).width() / zoneProportion +"px";
});
$( window ).resize(function() {
  renderer.view.style.width = $( window ).width()+"px";
  renderer.view.style.height = $( window ).width() / zoneProportion +"px";
});

var sheepZone, sheep, sheepBright;
var pinkZone, pink, pinkBright;
var boatZone, boat, boatTexture, boatPaddle;
var boatFlagZone, flag, boatBanbanZone, banban;
var landZone, land, landBack;
var flowZone, flow, flowBack;
var mountainZone, mountain, mountainBack;
var whaleZone, whale, waterColumn;
var skyZone, sky;

var boatPaddleRo = 0.0;
var isWaterGo = false, isWaterDown = false, waterScale = 1.0;
var message, messageOutput;

var physicsObjects = [], hitAreaRecs = [], fireObjects = [], firedObjects = [];

var startDate = new Date();
var goBoatDate = new Date("2016-5-18 00:00:00");
var spantime, d, h, m, s;

var rotationV = [0.0,0.002,0.005,0.05,0.0005];
var rotationMax = [0.0,0.07,0.5,0.5,0.02];

var randomMovingTime = 1.0;
var randomMovingTimeCount = randomMovingTime;

var scaleV = [0.0,0.0005,0.002,0.005,0.05];
var scaleXMax = [0.0,0.02,0.05,0.1,0.5];
var scaleYMax = [0.0,0.02,0.05,0.1,0.5];

var nodTexture, nodInBoatWidth = 10, nodInBoatHeight = 10;
var isFireMode = false, isBursting = false, tempCover, fireHeart;

function setPhysics(chara,vx,vy,atx,aty,horizontalPlane,isFalling,isInBoat,isInFlow,isMoving){
  chara.vx = vx; chara.vy = vy; chara.atx = atx; chara.aty = aty;
  chara.horizontalPlane = horizontalPlane;
  chara.isFalling = isFalling; chara.isInBoat = isInBoat; chara.isInFlow = isInFlow;
  chara.isMoving = isMoving;
  physicsObjects.push(chara);
}
function setHitArea(chara,x,y,width,height){
  chara.interactive = true; chara.buttonMode = true;
  chara.hitArea = new PIXI.Rectangle(x,y,width,height);
  hitAreaRecs.push(chara);
}
function setRotation(chara,rotation,rotationFlag,rotationValue,rotationTime){
  chara.rotation = rotation; chara.rotationFlag = rotationFlag; chara.rotationValue = rotationValue;
}
function setMoving(chara,isMoving,movingSpeed,goalX,goalY){
  chara.isMoving = isMoving; chara.movingSpeed = movingSpeed;
  chara.goalX = goalX; chara.goalY = goalY; 
}
function setDirMoving(chara,isMoving,movingSpeed,goalX,goalY){
  chara.isMoving = isMoving; chara.movingSpeed = movingSpeed;
  chara.goalX = goalX; chara.goalY = goalY; 
  chara.movingSpeedX = (goalX - chara.x) / movingSpeed;
  chara.movingSpeedY = (goalY - chara.y) / movingSpeed;
}
function setScale(chara,oScale,scaleFlag,scaleValue,scaleTime){
  chara.scale.x = oScale; chara.scale.y = oScale; chara.scale.o = oScale;
  chara.scaleFlag = scaleFlag; chara.scaleValue = scaleValue;
  chara.scaleTime = chara.scaleTime;
}
function setup() {
  fireHeart = new Sprite(Texture.fromImage('http://i.imgur.com/iEVTQwn.png'));
  fireHeart.visible = false;
  fireHeart.anchor.set(0.5, 0.5);
  setScale(fireHeart,0.5,true,1,-1);
  stage.addChild(fireHeart);

  nodTexture = Texture.fromImage('http://i.imgur.com/LDd4k1C.gif');
  //nodTexture = Texture.fromImage('http://i.imgur.com/FdOopTP.png');

  sheepZone = new Container();
  sheepZone.textures = [];
  sheepZone.textures.push(Texture.fromImage('http://i.imgur.com/PkYtBhg.png')); //sheep
  sheepZone.textures.push(Texture.fromImage('http://i.imgur.com/N4nj96o.png')); //sheepLove
  sheepZone.textures.push(Texture.fromImage('http://i.imgur.com/qMolVry.png')); //sheepBright
  sheepZone.textures.push(Texture.fromImage('http://i.imgur.com/Fxdv48h.gif')); //sheepDrag
  sheepZone.pivot.set(110, 160); sheepZone.position.set(1000, 200);
  sheepZone.on('pointerdown', onCharaDown).on('pointerup', onCharaUp)
           .on('pointerupoutside', onCharaUp).on('pointermove', onCharaDragMove)
           .on('pointerover', onCharaOver).on('pointerout', onCharaOut);
  sheep = new Sprite(sheepZone.textures[0]);
  sheepBright = new Sprite(sheepZone.textures[2]);
  sheepZone.addChild(sheepBright);
  sheepZone.addChild(sheep);
  stage.addChild(sheepZone);
  setPhysics(sheepZone,0,0,0,5.0,525,true,false,false,false);
  setHitArea(sheepZone,0,40,220,200);
  setRotation(sheepZone,0,true,1,-1); 
  setMoving(sheepZone,false,40.0,0.0,sheepZone.horizontalPlane);
  sheepZone.randomMovingTime = 3.0; 
  sheepZone.isFiring = false;
  setScale(sheepZone,0.8,true,1,-1);

  pinkZone = new Container();
  pinkZone.textures = [];
  pinkZone.textures.push(Texture.fromImage('http://i.imgur.com/Z5hkuz8.png')); //pink
  pinkZone.textures.push(Texture.fromImage('http://i.imgur.com/8ymjOwl.png')); //pinkLove
  pinkZone.textures.push(Texture.fromImage('http://i.imgur.com/ykXk0nY.png')); //pinkBright
  pinkZone.textures.push(Texture.fromImage('http://i.imgur.com/ErJ36Xy.gif')); //pinkDrag
  pinkZone.pivot.set(110, 160); pinkZone.position.set(1170, 200);
  pinkZone.on('pointerdown', onCharaDown).on('pointerup', onCharaUp)
          .on('pointerupoutside', onCharaUp).on('pointermove', onCharaDragMove)
          .on('pointerover', onCharaOver).on('pointerout', onCharaOut);
  pink = new Sprite(pinkZone.textures[0]);
  pinkBright = new Sprite(pinkZone.textures[2]);
  pinkZone.addChild(pinkBright);
  pinkZone.addChild(pink);
  stage.addChild(pinkZone);
  setPhysics(pinkZone,0,0,0,5.0,525,true,false,false,false);
  setHitArea(pinkZone,0,40,220,200);
  setRotation(pinkZone,0,true,1,-1); 
  setMoving(pinkZone,false,40.0,0.0,pinkZone.horizontalPlane);
  pinkZone.randomMovingTime = 3.0;
  pinkZone.isFiring = false; 
  setScale(pinkZone,0.8,true,1,-1);

  whaleZone = new Container();
  whaleZone.position.set(300, 400);
  whale = new Sprite(Texture.fromImage('http://i.imgur.com/6K5s214.png'));
  whale.on('pointerdown', onWhaleDown);  
  setHitArea(whale,0,100,1000,180);
  stage.addChild(whale);
  waterColumn = new Sprite(Texture.fromImage('http://i.imgur.com/pxI8pSI.png'));
  waterColumn.position.set(300, 100);
  waterColumn.anchor.set(0.5, 0.96);
  whaleZone.addChild(waterColumn);
  whaleZone.addChild(whale);
  setScale(whaleZone,0.7,true,0,1);
  stage.addChild(whaleZone);

  boatZone = new Container();
  boatZone.position.set(1000, 670);
  boatZone.vx = 1.0; boatZone.atx = 0;
  boatZone.stopLine = 1750; boatZone.isStop = false; boatZone.isAccelerate = false;
  setScale(boatZone,0.8,true,1,-1);
  setRotation(boatZone,0,true,4,-1); 

  boat = new Sprite();
  boat.oTexture = Texture.fromImage('http://i.imgur.com/B6MNMzM.png');
  boat.texture = new PIXI.Texture(boat.oTexture, new PIXI.Rectangle(0, 0, 664, 210))
  boat.anchor.set(0.0, 0.0);
  boat.position.set(-332, -260);
  boat.on('pointerdown', onBoatDown);
  setHitArea(boat,0,120,640,140);
  boatPaddle = new Sprite(Texture.fromImage('http://i.imgur.com/wSdBTV6.png'));
  boatPaddle.anchor.set(0.5, 0.5);
  boatPaddle.position.set(150, -100);
  boatZone.addChild(boat);
  boatZone.addChild(boatPaddle);
  stage.addChild(boatZone);

  boatBanbanZone = new Container();
  boatBanbanZone.position.set(1000, 670);
  setScale(boatBanbanZone,0.8,true,1,-1);
  setRotation(boatBanbanZone,0,true,4,-1); 
  banban = new Sprite(Texture.fromImage('http://i.imgur.com/LA2U7hy.png'));
  banban.anchor.set(0.5, 1.0);
  banban.pivot.set(0.0, 0.0);
  banban.position.set(30, -140);
  boatBanbanZone.addChild(banban);
  stage.addChild(boatBanbanZone);

  boatFlagZone = new Container();
  boatFlagZone.position.set(1000, 670);
  setScale(boatFlagZone,0.8,true,1,-1);
  setRotation(boatFlagZone,0,true,4,-1); 
  flag = new Sprite(Texture.fromImage('http://i.imgur.com/YdzjFUh.png'));
  flag.anchor.set(0.5, 1.0);
  flag.pivot.set(0.0, 0.0);
  flag.position.set(200, -400);
  flag.on('pointerdown', onFlagDown);
  setHitArea(flag,-250,-250,200,200);
  boatFlagZone.addChild(flag);
  stage.addChild(boatFlagZone);

  landZone = new Container();
  landZone.position.set(-4000, 0);
  land = new Sprite(Texture.fromImage('http://i.imgur.com/dv9hRw2.png'));
  land.position.set(0, 0);
  landBack = new Sprite(Texture.fromImage('http://i.imgur.com/dv9hRw2.png'));
  landBack.position.set(4000, 0);
  landZone.addChild(land);
  landZone.addChild(landBack);
  stage.addChild(landZone);
  landZone.on('pointerdown', shootNod);
  setHitArea(landZone,-2000,700,8000,100);

  flowZone = new Container();
  flowZone.position.set(-4000, 0);
  flow = new Sprite(Texture.fromImage('http://i.imgur.com/1v2Gru5.png'));
  flow.position.set(0, 0);
  flowBack = new Sprite(Texture.fromImage('http://i.imgur.com/1v2Gru5.png'));
  flowBack.position.set(4000, 0);
  flowZone.addChild(flow);
  flowZone.addChild(flowBack);
  stage.addChild(flowZone);
  flowZone.flowSpeed = 5.0; 

  mountainZone = new Container();
  mountainZone.position.set(-4000, 0);
  mountain = new Sprite(Texture.fromImage('http://i.imgur.com/XVwrBAF.png'));
  mountain.position.set(0, 0);
  mountainBack = new Sprite(Texture.fromImage('http://i.imgur.com/XVwrBAF.png'));
  mountainBack.position.set(4000, 0);
  mountainZone.addChild(mountain);
  mountainZone.addChild(mountainBack);
  stage.addChild(mountainZone);

  skyZone = new Container();
  sky = new Sprite(Texture.fromImage('http://i.imgur.com/c8Be7L1.png'));
  sky.position.set(0, 0);
  skyZone.addChild(sky);
  stage.addChild(skyZone);
  
  message = new PIXI.Text(messageOutput, 
    {font: "32px sans-serif", fill: "white"}
  );
  message.position.set(10, 10);
  stage.addChild(message);

  skyZone.zIndex = 0;
  mountainZone.zIndex = 10;
  whaleZone.zIndex = 49.9999;
  flowZone.zIndex = 50;
  boatBanbanZone.zIndex = 69.9997;
  boatFlagZone.zIndex = 69.9998;
  pinkZone.zIndex = 69.9999;
  sheepZone.zIndex = 70;
  boatZone.zIndex = 70.0001;
  landZone.zIndex = 100;
  fireHeart.zIndex = 300;
  message.zIndex = 1000;

  for(var i = 0;i< hitAreaRecs.length;i++){
    hitAreaRecs[i].hitAreaRec = new PIXI.Graphics();
    hitAreaRecs[i].hitAreaRec.beginFill(0xFFFFFF, 0.5);
    hitAreaRecs[i].hitAreaRec.lineStyle(1, 0x000000, 0.5);
    hitAreaRecs[i].hitAreaRec.drawRect(hitAreaRecs[i].hitArea.x, hitAreaRecs[i].hitArea.y, 
      hitAreaRecs[i].hitArea.width, hitAreaRecs[i].hitArea.height);
    //hitAreaRecs[i].addChild(hitAreaRecs[i].hitAreaRec);
  }

  stage.children.sort(function(a,b) { return a.zIndex - b.zIndex; }); 
  gameLoop();
}
//------------------------------------------------------------------------------------------------
function updateState() {
  //sort-----------------------
  stage.children.sort(function(a,b) { 
    a.zIndex = a.zIndex || 0;
    b.zIndex = b.zIndex || 0;
    return a.zIndex - b.zIndex;
  }); 

  //fire------------------------------------------------------------------
  if(isFireMode){
    fireHeart.position.set(renderer.plugins.interaction.mouse.global.x,
      renderer.plugins.interaction.mouse.global.y);
    scaleMagic(fireHeart,1.0); 
    if(isBursting && fireObjects.length > 0){
      setDirMoving(fireObjects[fireObjects.length-1],true,20.0,
        renderer.plugins.interaction.mouse.global.x,
        renderer.plugins.interaction.mouse.global.y);
      fireObjects[fireObjects.length-1].isFiring = true;
      fireObjects[fireObjects.length-1].isInBoat = false;
      firedObjects.push(fireObjects[fireObjects.length-1]);
      fireObjects.splice(fireObjects.length-1, 1); 
    }
    for(var i = 0 ; i < firedObjects.length ; i++){
      movingDirMagic(firedObjects[i]);
      if(!firedObjects[i].isMoving){
          firedObjects[i].isFiring = false;
          firedObjects[i].isFalling = true;
          setFireObjectHorizontalPlane(firedObjects[i]);
          firedObjects.splice(i, 1); 
      }
    }
  }

  //boat--------------------------
  if(boatZone.x >= boatZone.stopLine && !boatZone.isAccelerate) boatZone.isStop = true;
  else boatZone.isStop = false;
  if(boatZone.isAccelerate) boatZone.atx += 0.2;
  if(boatZone.atx >= 0.0) boatZone.isAccelerate = false;
  if(!boatZone.isStop){ 
    boatZone.x += ( boatZone.vx + boatZone.atx );
    boatFlagZone.x = boatZone.x;
    boatBanbanZone.x = boatZone.x;
  }
  rotateMagic(boatZone); rotateMagic(boatFlagZone); rotateMagic(boatBanbanZone); 
  scaleMagic(boatZone,1.0);  scaleMagic(boatFlagZone,1.0); scaleMagic(boatBanbanZone,1.0); 

  //boatPaddle--------------------
  boatPaddle.rotation += boatPaddleRo;
  if(boatPaddle.rotation < -6.28){ boatPaddleRo = 0.0;
    boatPaddle.rotation = 0.0;
  }

  //Water-------------------------
  if(isWaterGo){ 
    if(!isWaterDown && waterColumn.scale.y < 15.0) waterColumn.scale.y += 1.0;
    else {
      isWaterDown = true ; 
      if(isWaterDown && waterColumn.scale.y >= 1.0) waterColumn.scale.y -= 0.05;
      else{ isWaterDown = false; isWaterGo = false ; }
    }
  }

  //Zone--------------------------
  landZone.x += 4;
  if(landZone.x >= 0) landZone.x = -4000;
  flowZone.x += 3;
  if(flowZone.x >= 0) flowZone.x = -4000;
  mountainZone.x += 1;
  if(mountainZone.x >= 0) mountainZone.x = -4000;

  //physicsObjects-------------------------------
  randomMovingTimeCount -= 1.0/60.0;
  for(var i = 0 ; i < physicsObjects.length ; i++){
    if(physicsObjects[i].willBeDead && physicsObjects[i].x > 2500.0)
    {
      physicsObjects[i].destroy();
      physicsObjects.splice(i, 1); 
      i -= 1; continue;
    }
    else if(!physicsObjects[i].willBeDead && physicsObjects[i].x > 2500.0){
      physicsObjects[i].x = 1000; physicsObjects[i].y = -400;
      physicsObjects[i].isInFlow = false; physicsObjects[i].isFalling = true;
    }
    else if(physicsObjects[i].dragging){}
    else if(physicsObjects[i].isFiring){}
    else if(physicsObjects[i].isFalling){
      physicsObjects[i].vy += ( 0.07 * physicsObjects[i].aty );
      physicsObjects[i].y += ( physicsObjects[i].vy + physicsObjects[i].aty ) ;  
      physicsObjects[i].x += physicsObjects[i].vx;
      if(i===0||i===1) physicsObjects[i].children[1].texture = physicsObjects[i].textures[3]; 
      if(physicsObjects[i].vy > 0 && physicsObjects[i].y >= physicsObjects[i].horizontalPlane){ 
        physicsObjects[i].isFalling = false;
        physicsObjects[i].vy = 0;
      }
    }
    else if(physicsObjects[i].isInBoat){
      if(!physicsObjects[i].isMoving && randomMovingTimeCount<0.0 && Math.floor(Math.random()*2)<1.0){
        setMoving(physicsObjects[i],true,30,
          Math.floor(Math.random()*300)-150,physicsObjects[i].horizontalPlane-boatZone.y);
      }
      if(physicsObjects[i].isMoving) movingMagic(physicsObjects[i],boatZone);
      if(!boatZone.isStop) physicsObjects[i].x += ( boatZone.vx + boatZone.atx ) ;
    }
    else{ //physicsObjects[i].isInFlow = true
      if(physicsObjects[i].x < (boatZone.x + 280) && physicsObjects[i].x > (boatZone.x - 280) &&
        physicsObjects[i].zIndex <= (sheepZone.zIndex + 15) &&
        physicsObjects[i].zIndex >= (sheepZone.zIndex - 10) )
      { 
          physicsObjects[i].isInBoat = true; physicsObjects[i].isInFlow = false;
          physicsObjects[i].rotationValue = 1;
          if(i===0||i===1){ 
            physicsObjects[i].children[1].texture = physicsObjects[i].textures[0]; 
            setMoving(physicsObjects[i],true,30,0,physicsObjects[i].horizontalPlane-boatZone.y);
          }
          else{ 
            fireObjects.push(physicsObjects[i]);
            setMoving(physicsObjects[i],true,30,
            0,sheepZone.horizontalPlane + 10 - boatZone.y - Math.floor(fireObjects.length/nodInBoatWidth)*nodInBoatHeight);
            physicsObjects[i].zIndex = 69 - Math.random();
          }
      }
      else{
        physicsObjects[i].isInFlow = true;
        if(i!==0 && i!==1){
          if(!physicsObjects[i].isMoving && physicsObjects[0].isInFlow){
            setMoving(physicsObjects[i],true,10,Math.floor(Math.random() * 101)-50,
              Math.floor(Math.random() * 21)-10 + 70);
            physicsObjects[i].zIndex = 70.0 + Math.floor(Math.random() * 2) - 1;
          }
          if(physicsObjects[i].isMoving) movingMagic(physicsObjects[i],sheepZone);
        }
        physicsObjects[i].rotationValue = 3;
        physicsObjects[i].x += flowZone.flowSpeed; 
      }
    }
    rotateMagic(physicsObjects[i]);
    scaleMagic(physicsObjects[i],-1.0);
  }
  if(randomMovingTimeCount < 0.0 ) randomMovingTimeCount = randomMovingTime ;
  
  //Time-------------------------------
  startDate = new Date();
	spantime = (startDate.getTime() - goBoatDate)/1000;
	d = Math.floor(spantime / (24 * 3600));
	h = Math.floor((spantime % (24*3600))/3600);
	m = Math.floor((spantime % 3600)/(60));
	s = Math.floor(spantime%60);
	message.text = "LoveBoat 航行時間 : " +d+" 日 "+h+" 時 "+m+" 分 "+s+" 秒";
  message.text += " / nod 收集數量 : " + fireObjects.length + " 個";
}
function gameLoop(){
  requestAnimationFrame(gameLoop);
  updateState();
  renderer.render(stage);
}
setup();
//------------------------------------------------------------------------------------------------
function shootNod(event) {
  for(var i = 0 ; i < 10 ; i++){
    var newNod = new Sprite(nodTexture);
    newNod.pivot.set(205, 176);
    newNod.position.set(event.data.getLocalPosition(this.parent).x,event.data.getLocalPosition(this.parent).y);
    newNod.willBeDead = true;
    var vx = Math.floor(Math.random() * 2100)/100.0-10; //-10.00~10.00 
    var vy = (-30-Math.floor(Math.random() * 2500)/100.0); //-30.00~-55.00
    var atx = 0, aty = 9.0;
    setFireObjectHorizontalPlane(newNod);
    setPhysics(newNod,vx,vy,atx,aty,newNod.horizontalPlane,true,false,false,false);
    setRotation(newNod,0,true,2,-1); 
    setMoving(newNod,false,60.0,0.0,newNod.horizontalPlane);
    newNod.randomMovingTime = 3.0;
    setScale(newNod,0.2,true,1,-1);
    newNod.isFiring = false;
    stage.addChild(newNod);
  }
}
function setFireObjectHorizontalPlane(chara){
  chara.zIndex = 75.0 + Math.floor(Math.random() * 4999)/100.0 - 25.0; //50~100
  if(chara.zIndex < sheepZone.zIndex){ //50~70
      chara.horizontalPlane = 500 + (chara.zIndex-50)*120.0/20.0;
      if(chara.zIndex >= 70.0) chara.zIndex = 69 - Math.random();
    }
    else{ //70~100
      chara.horizontalPlane = 620 + (chara.zIndex-70)*180.0/30.0 - 100.0;
      if(chara.zIndex >= 100.0) chara.zIndex = 99 - Math.random();
    }
}
//------------------------------------------------------------------------------------------------
function scaleMagic(chara,type) {
  if((chara.scale.x - chara.scale.o) > scaleXMax[chara.scaleValue]){
    chara.scaleFlag = !chara.scaleFlag;
    chara.scale.x = chara.scale.o + scaleXMax[chara.scaleValue];
    chara.scale.y = chara.scale.o + type*scaleYMax[chara.scaleValue];
  }
  else if((chara.scale.o - chara.scale.x) > scaleXMax[chara.scaleValue]){
    chara.scaleFlag = !chara.scaleFlag;
    chara.scale.x = chara.scale.o - scaleXMax[chara.scaleValue];
    chara.scale.y = chara.scale.o - type*scaleYMax[chara.scaleValue];
  }
  if(chara.scaleFlag) {
    chara.scale.x += scaleV[chara.scaleValue];
    chara.scale.y += type*scaleV[chara.scaleValue];
  }
  else{
    chara.scale.x -= scaleV[chara.scaleValue];
    chara.scale.y -= type*scaleV[chara.scaleValue];
  }
}
function movingDirMagic(chara) {
  chara.x += chara.movingSpeedX;
  chara.y += chara.movingSpeedY;
  if(Math.abs(chara.x - chara.goalX) < 0.1 && Math.abs(chara.y - chara.goalY) < 0.1 ){
    chara.isMoving = false;
    chara.vx = chara.movingSpeedX;
    chara.vy = chara.movingSpeedY;
  }
}
function movingMagic(chara,goal) {
  var tempX = goal.x + chara.goalX - chara.x;
  var tempY = goal.y + chara.goalY - chara.y;
  chara.x += tempX/chara.movingSpeed;
  chara.y += tempY/chara.movingSpeed;
  if(Math.abs(tempX) < 5.0 && Math.abs(tempY) < 5.0 ){
    chara.isMoving = false;
    chara.horizontalPlane = chara.y;
  }
}
function rotateMagic(chara) {
  if(chara.rotation>rotationMax[chara.rotationValue]) {
    chara.rotationFlag = !chara.rotationFlag;
    chara.rotation = rotationMax[chara.rotationValue];
  }
  else if(chara.rotation<-rotationMax[chara.rotationValue]){
    chara.rotationFlag = !chara.rotationFlag;
    chara.rotation = -rotationMax[chara.rotationValue];
  }
  if(chara.rotationFlag) chara.rotation += rotationV[chara.rotationValue]; 
  else chara.rotation -= rotationV[chara.rotationValue];
}
//------------------------------------------------------------------------------------------------
function onTempCoverDown(){
  isBursting = true;
}
function onTempCoverUp(){
  isBursting = false;
}
function onFlagDown() {
  isFireMode = !isFireMode;
  if(isFireMode){
    tempCover = new Container();
    setHitArea(tempCover,0,0,2000,800);
    tempCover.on('pointerdown', onTempCoverDown)
             .on('pointerup', onTempCoverUp);
    tempCover.zIndex = 200;
    boatFlagZone.zIndex = 201;
    stage.addChild(tempCover);
    fireHeart.visible = true;
  }
  else{
    fireHeart.visible = false;
    boatFlagZone.zIndex = 69.9998;
    tempCover.destroy();
  }
}
function onBoatDown() {
	boatZone.isAccelerate = true;
	boatZone.atx = -15.0;
	boatPaddleRo = -0.5;
}
function onWhaleDown() {
  isWaterGo = true;
}
//------------------------------------------------------------------------------------------------
function onCharaDown(event) {
	this.children[1].texture = this.textures[3];
  this.isdown = true;
  this.isMoving = false; this.dragging = true; this.isInBoat = false; this.isInFlow = false;
  this.fixX = this.x - event.data.getLocalPosition(this.parent).x;
  this.fixY = this.y - event.data.getLocalPosition(this.parent).y;
  this.rotationValue = 2;
}
function onCharaUp() {
  this.isdown = false;
  this.dragging = false;
  if(this.isOver && this.isInBoat){ this.children[1].texture = this.textures[1]; }
  else{ this.children[1].texture = this.textures[0]; } 
	this.isFalling = true;
}
function onCharaOver() {
  this.children[1].isOver = true;
  if (this.isdown) { return; }
  if(this.isInBoat) this.children[1].texture = this.textures[1];
}
function onCharaOut() {
  this.isOver = false;
  if (this.isdown) { return; }
  if(this.isInBoat) this.children[1].texture = this.textures[0];
}
function onCharaDragMove(event) {
  if (this.dragging) {
    this.x = event.data.getLocalPosition(this.parent).x + this.fixX;
    this.y = event.data.getLocalPosition(this.parent).y + this.fixY;
  }
}
//------------------------------------------------------------------------------------------------
function debugPrintObjectLength(){
  console.log("stage.children "+stage.children.length);
  console.log("physicsObjects "+physicsObjects.length);
  console.log("hitAreaRecs "+hitAreaRecs.length);
  console.log("fireObjects "+fireObjects.length);
  console.log("firedObjects "+firedObjects.length);
  console.log("---------------------------------");
}
</script>
</body>

