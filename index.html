<!doctype html>
<meta charset="utf-8">
<title>LoveBoat</title>
<body style="margin:0px;">
<script src="pixi.min.js"></script>
<script src="jquery.min.js"></script>
<script>
//Aliases
var Container = PIXI.Container,
    autoDetectRenderer = PIXI.autoDetectRenderer,
    loader = PIXI.loader,
    resources = PIXI.loader.resources,
    TextureCache = PIXI.utils.TextureCache,
    Sprite = PIXI.Sprite;
    Texture = PIXI.Texture;

var zoneProportion = 2000 / 800;
var renderer = autoDetectRenderer(2000, 800);
document.body.appendChild(renderer.view);
var stage = new Container();
renderer.backgroundColor = 0xF2BDD0;
renderer.render(stage);

$( window ).ready(function() {
  renderer.view.style.width = $( window ).width()+"px";
  renderer.view.style.height = $( window ).width() / zoneProportion +"px";
});
$( window ).resize(function() {
  renderer.view.style.width = $( window ).width()+"px";
  renderer.view.style.height = $( window ).width() / zoneProportion +"px";
});

var sheepZone, sheep, sheepBright;
var pinkZone, pink, pinkBright;
var boatZone, boat, boatTexture, banban, flag, boatPaddle;
var landZone, land, landBack;
var flowZone, flow, flowBack;
var mountainZone, mountain, mountainBack;
var whale, waterColumn;
var nodTexture;

var boatPaddleRo = 0.0;
var isWaterGo = false, isWaterDown = false, waterScale = 1.0;
var message, messageOutput;
var physicsObjects = [];
var startDate = new Date();
var goBoatDate = new Date("2016-5-18 00:00:00");
var spantime, d, h, m, s;
var hitAreaRecs = [];

var rotationObjects = [];
var rotationV = [0.0,0.002,0.005,0.05];
var rotationMax = [0.0,0.07,0.5,0.5];

function setup() {
  nodTexture = Texture.fromImage('use/nod.gif');

  sheepZone
  sheepZone = new Container();
  sheepZone.textures = [];
  sheepZone.textures.push(Texture.fromImage('http://i.imgur.com/PkYtBhg.png')); //sheep
  sheepZone.textures.push(Texture.fromImage('http://i.imgur.com/N4nj96o.png')); //sheepLove
  sheepZone.textures.push(Texture.fromImage('http://i.imgur.com/qMolVry.png')); //sheepBright
  sheepZone.textures.push(Texture.fromImage('http://i.imgur.com/Fxdv48h.gif')); //sheepDrag
  sheepZone.pivot.set(110, 160); 
  sheepZone.position.set(1000, 200);
  sheepZone.scale.set(0.8);
  sheepZone.interactive = true;
  sheepZone.buttonMode = true;
  sheepZone.on('pointerdown', onCharaDown)
       .on('pointerup', onCharaUp)
       .on('pointerupoutside', onCharaUp)
       .on('pointermove', onCharaDragMove)
       .on('pointerover', onCharaOver)
       .on('pointerout', onCharaOut);
  sheep = new Sprite(sheepZone.textures[0]);
  sheepBright = new Sprite(sheepZone.textures[2]);
  sheepZone.addChild(sheepBright);
  sheepZone.addChild(sheep);
  stage.addChild(sheepZone);
  sheepZone.vx = 0; sheepZone.vy = 0;
  sheepZone.atx = 0; sheepZone.aty = 5.0;
  sheepZone.horizontalPlane = 530;
  sheepZone.isFalling = true;
  physicsObjects.push(sheepZone);
  sheepZone.hitArea = new PIXI.Rectangle(0,40, 220, 200);
  hitAreaRecs.push(sheepZone);
  sheepZone.rotation = 0; sheepZone.rotationFlag = true; sheepZone.rotationValue = 1;
  rotationObjects.push(sheepZone);

  pinkZone = new Container();
  pinkZone.textures = [];
  pinkZone.textures.push(Texture.fromImage('http://i.imgur.com/Z5hkuz8.png')); //pink
  pinkZone.textures.push(Texture.fromImage('http://i.imgur.com/8ymjOwl.png')); //pinkLove
  pinkZone.textures.push(Texture.fromImage('http://i.imgur.com/ykXk0nY.png')); //pinkBright
  pinkZone.textures.push(Texture.fromImage('http://i.imgur.com/ErJ36Xy.gif')); //pinkDrag
  pinkZone.pivot.set(110, 160); 
  pinkZone.position.set(1170, 200);
  pinkZone.scale.set(0.8);
  pinkZone.interactive = true;
  pinkZone.buttonMode = true;
  pinkZone.on('pointerdown', onCharaDown)
       .on('pointerup', onCharaUp)
       .on('pointerupoutside', onCharaUp)
       .on('pointermove', onCharaDragMove)
       .on('pointerover', onCharaOver)
       .on('pointerout', onCharaOut);
  pink = new Sprite(pinkZone.textures[0]);
  pink.position.set(0, 0);
  pinkBright = new Sprite(pinkZone.textures[2]);
  pinkZone.addChild(pinkBright);
  pinkZone.addChild(pink);
  stage.addChild(pinkZone);
  pinkZone.vx = 0;  pinkZone.vy = 0;
  pinkZone.atx = 0; pinkZone.aty = 5.0;
  pinkZone.horizontalPlane = 530;
  pinkZone.isFalling = true;
  physicsObjects.push(pinkZone);
  pinkZone.hitArea = new PIXI.Rectangle(0,40, 220, 200);
  hitAreaRecs.push(pinkZone);
  pinkZone.rotation = 0; pinkZone.rotationFlag = true; pinkZone.rotationValue = 1;
  rotationObjects.push(pinkZone);

  whale = new Sprite(Texture.fromImage('http://i.imgur.com/6K5s214.png'));
  whale.position.set(300, 300);
  whale.interactive = true;
  whale.buttonMode = true;
  whale.on('pointerdown', onWhaleDown);
  stage.addChild(whale);
  whale.hitArea = new PIXI.Rectangle(0, 100, 1000, 180);
  hitAreaRecs.push(whale);
  waterColumn = new Sprite(Texture.fromImage('http://i.imgur.com/pxI8pSI.png'));
  waterColumn.position.set(580, 400);
  waterColumn.anchor.set(0.5, 0.96);
  waterColumn.scale.y = 1.0;
  stage.addChild(waterColumn);

  boatZone = new Container();
  boatZone.position.set(1000, 670);
  boatZone.scale.set(0.8);
  boatZone.vx = 2.0;
  boatZone.atx = 0;
  boatZone.stopLine = 1750;
  boatZone.isStop = false;
  boatZone.isAccelerate = false;

  boat = new Sprite();
  boat.oTexture = Texture.fromImage('http://i.imgur.com/B6MNMzM.png');
  boat.texture = new PIXI.Texture(boat.oTexture, new PIXI.Rectangle(0, 0, 664, 200))
  boat.anchor.set(0.0, 0.0);
  boat.position.set(-332, -260); //boat.getGlobalPosition().x
  boat.interactive = true;
  boat.buttonMode = true;
  boat.on('pointerdown', onBoatDown);
  boat.hitArea = new PIXI.Rectangle(0, 120, 640, 140);
  hitAreaRecs.push(boat);

  banban = new Sprite(Texture.fromImage('http://i.imgur.com/LA2U7hy.png'));
  banban.anchor.set(0.5, 1.0);
  banban.position.set(30, -140);
  flag = new Sprite(Texture.fromImage('http://i.imgur.com/YdzjFUh.png'));
  flag.anchor.set(0.5, 1.0);
  flag.position.set(200, -400);
  boatPaddle = new Sprite(Texture.fromImage('http://i.imgur.com/wSdBTV6.png'));
  boatPaddle.anchor.set(0.5, 0.5);
  boatPaddle.position.set(150, -100); 
  boatZone.addChild(boat);
  boatZone.addChild(banban);
  boatZone.addChild(flag);
  boatZone.addChild(boatPaddle);
  stage.addChild(boatZone);

  landZone = new Container();
  landZone.position.set(-4000, 0);
  land = new Sprite(Texture.fromImage('http://i.imgur.com/dv9hRw2.png'));
  land.position.set(0, 0);
  landBack = new Sprite(Texture.fromImage('http://i.imgur.com/dv9hRw2.png'));
  landBack.position.set(4000, 0);
  landZone.addChild(land);
  landZone.addChild(landBack);
  stage.addChild(landZone);
  landZone.interactive = true;
  landZone.buttonMode = true;
  landZone.on('pointerdown', shootNod);
  landZone.hitArea = new PIXI.Rectangle(-2000, 700, 8000, 100);
  hitAreaRecs.push(landZone);

  flowZone = new Container();
  flowZone.position.set(-4000, 0);
  flow = new Sprite(Texture.fromImage('http://i.imgur.com/1v2Gru5.png'));
  flow.position.set(0, 0);
  flowBack = new Sprite(Texture.fromImage('http://i.imgur.com/1v2Gru5.png'));
  flowBack.position.set(4000, 0);
  flowZone.addChild(flow);
  flowZone.addChild(flowBack);
  stage.addChild(flowZone);
  flowZone.flowSpeed = 5.0; 

  mountainZone = new Container();
  mountainZone.position.set(-4000, 0);
  mountain = new Sprite(Texture.fromImage('http://i.imgur.com/XVwrBAF.png'));
  mountain.position.set(0, 0);
  mountainBack = new Sprite(Texture.fromImage('http://i.imgur.com/XVwrBAF.png'));
  mountainBack.position.set(4000, 0);
  mountainZone.addChild(mountain);
  mountainZone.addChild(mountainBack);
  stage.addChild(mountainZone);
  
  mountainZone.zIndex = 10;
  flowZone.zIndex = 50;
  whale.zIndex = 60;
  waterColumn.zIndex = 59.99;
  sheepZone.zIndex = 70;
  pinkZone.zIndex = 69.99;
  boatZone.zIndex = 80;
  landZone.zIndex = 100;

  message = new PIXI.Text(
	  messageOutput, 
	  {font: "32px sans-serif", fill: "white"}
	);
  message.position.set(10, 10);
  stage.addChild(message);

  for(var i = 0;i< hitAreaRecs.length;i++){
    hitAreaRecs[i].hitAreaRec = new PIXI.Graphics();
    hitAreaRecs[i].hitAreaRec.beginFill(0xFFFFFF, 0.5);
    hitAreaRecs[i].hitAreaRec.lineStyle(1, 0x000000, 0.5);
    hitAreaRecs[i].hitAreaRec.drawRect(hitAreaRecs[i].hitArea.x, hitAreaRecs[i].hitArea.y, 
      hitAreaRecs[i].hitArea.width, hitAreaRecs[i].hitArea.height);
    //hitAreaRecs[i].addChild(hitAreaRecs[i].hitAreaRec);
  }

  stage.children.sort(function(a,b) { return a.zIndex - b.zIndex; }); 
  gameLoop();
}

function updateState() {
  stage.children.sort(function(a,b) { 
    a.zIndex = a.zIndex || 0;
    b.zIndex = b.zIndex || 0;
    return a.zIndex - b.zIndex;
  }); 

  if(boatZone.x >= boatZone.stopLine && !boatZone.isAccelerate) boatZone.isStop = true;
  else boatZone.isStop = false;
  if(boatZone.isAccelerate) boatZone.atx += 0.2;
  if(boatZone.atx >= 0.0) boatZone.isAccelerate = false;
  if(!boatZone.isStop) boatZone.x += ( boatZone.vx + boatZone.atx ) ;

  for(var i = 0 ; i < physicsObjects.length ; i++){
    if(!physicsObjects[i].dragging){
      if(physicsObjects[i].isFalling && physicsObjects[i].vy > 0 && 
        physicsObjects[i].y >= physicsObjects[i].horizontalPlane){ 
        physicsObjects[i].isFalling = false;
        physicsObjects[i].vy = 0;
      }
      else if(physicsObjects[i].isFalling){
        physicsObjects[i].vy += ( 0.07 * physicsObjects[i].aty );
        physicsObjects[i].y += ( physicsObjects[i].vy + physicsObjects[i].aty ) ;  
        physicsObjects[i].x += physicsObjects[i].vx;
        if(i===0||i===1)
          physicsObjects[i].children[1].texture = physicsObjects[i].textures[3]; 
      }
      else{
        if(physicsObjects[i].x < (boatZone.x + 250) && physicsObjects[i].x > (boatZone.x - 250) &&
          physicsObjects[i].horizontalPlane < (sheepZone.horizontalPlane + 10) &&
          physicsObjects[i].horizontalPlane > (sheepZone.horizontalPlane - 10) )
        { 
          physicsObjects[i].isInBoat = true;
          physicsObjects[i].rotationValue = 1;
          if(i===0||i===1) physicsObjects[i].children[1].texture = physicsObjects[i].textures[0]; 
          if(!boatZone.isStop) physicsObjects[i].x += ( boatZone.vx + boatZone.atx ) ; 
        }
        else{
          physicsObjects[i].isInBoat = false;
          physicsObjects[i].rotationValue = 3;
          if(i===0||i===1) physicsObjects[i].children[1].texture = physicsObjects[i].textures[3]; 
          physicsObjects[i].x += flowZone.flowSpeed; 
        }
      }
    }
  }

	for(var i = 0 ; i < rotationObjects.length ; i++){
    rotateMagic(rotationObjects[i]);
  }

	boatPaddle.rotation += boatPaddleRo;
	if(boatPaddle.rotation < -6.28){ boatPaddleRo = 0.0;
		boatPaddle.rotation = 0.0;
	}

  if(isWaterGo){ 
    if(!isWaterDown && waterColumn.scale.y < 10.0) waterColumn.scale.y += 1.0;
    else {
      isWaterDown = true ; 
      if(isWaterDown && waterColumn.scale.y >= 1.0) waterColumn.scale.y -= 0.05;
      else{ isWaterDown = false; isWaterGo = false ; }
    }
  }

	landZone.x += 4;
	if(landZone.x >= 0) landZone.x = -4000;
	flowZone.x += 3;
	if(flowZone.x >= 0) flowZone.x = -4000;
	mountainZone.x += 1;
	if(mountainZone.x >= 0) mountainZone.x = -4000;

	spantime = (startDate.getTime() - goBoatDate)/1000;
	d = Math.floor(spantime / (24 * 3600));
	h = Math.floor((spantime % (24*3600))/3600);
	m = Math.floor((spantime % 3600)/(60));
	s = Math.floor(spantime%60);
	message.text = "LoveBoat 航行 " +d+" 日 "+h+" 時 "+m+" 分 "+s+" 秒";
}
function gameLoop(){
  requestAnimationFrame(gameLoop);
  updateState();
  renderer.render(stage);
}
setup();

function shootNod(event) {
  for(var i = 0 ; i < 10 ; i++){
    var index = physicsObjects.length;
    physicsObjects[index] = new Sprite(nodTexture);
    physicsObjects[index].pivot.set(205, 176);
    physicsObjects[index].position.set(event.data.getLocalPosition(this.parent).x,
     event.data.getLocalPosition(this.parent).y);
    physicsObjects[index].scale.set(0.2);
    physicsObjects[index].dragging = false;
    physicsObjects[index].isFalling = true;
    physicsObjects[index].vx = Math.floor(Math.random() * 11)-5;  
    physicsObjects[index].vy = (-20-Math.floor(Math.random() * 25));
    physicsObjects[index].atx = 0; 
    physicsObjects[index].aty = 5.0;
    var h = 600 + Math.floor(Math.random() * 20000)/100.0 -100; //500.00~699.99
    physicsObjects[index].horizontalPlane = h;
    if(physicsObjects[index].horizontalPlane < 530){ //500~530
      physicsObjects[index].zIndex = 50+(h-500)*20.0/30.0;
      if(physicsObjects[index].zIndex === 60.0) physicsObjects[index].zIndex = 59;
      if(physicsObjects[index].zIndex === 70.0) physicsObjects[index].zIndex = 69;
    }
    else if(physicsObjects[index].horizontalPlane < 540){ //530~540
      physicsObjects[index].zIndex = 70+(h-530)*10.0/10.0;
      if(physicsObjects[index].zIndex === 80.0) physicsObjects[index].zIndex = 79;
    }
    else{ //540~700
      physicsObjects[index].zIndex = 80+(h-540)*20.0/160.0;
      if(physicsObjects[index].zIndex === 100.0) physicsObjects[index].zIndex = 99;
    }
    stage.addChild(physicsObjects[physicsObjects.length-1]);
    physicsObjects[index].rotation = 0; 
    physicsObjects[index].rotationFlag = true; 
    physicsObjects[index].rotationValue = 1;
    rotationObjects.push(physicsObjects[index]);
    console.log(physicsObjects[index].zIndex);
  }
}

function rotateMagic(chara) {
  if(chara.rotation>rotationMax[chara.rotationValue]) {
    chara.rotationFlag = !chara.rotationFlag;
    chara.rotation = rotationMax[chara.rotationValue];
  }
  else if(chara.rotation<-rotationMax[chara.rotationValue]){
    chara.rotationFlag = !chara.rotationFlag;
    chara.rotation = -rotationMax[chara.rotationValue];
  }
  if(chara.rotationFlag) chara.rotation += rotationV[chara.rotationValue]; 
  else chara.rotation -= rotationV[chara.rotationValue];
}
//--------------------------------------------------------------
function onBoatDown() {
	boatZone.isAccelerate = true;
	boatZone.atx = -10.0;
	boatPaddleRo = -0.5;
}
function onWhaleDown() {
  isWaterGo = true;
}
//--------------------------------------------------------------
function onCharaDown(event) {
	this.children[1].texture = this.textures[3];
    this.isdown = true;
    this.dragging = true;
    this.fixX = this.x - event.data.getLocalPosition(this.parent).x;
    this.fixY = this.y - event.data.getLocalPosition(this.parent).y;
    this.rotationValue = 2;
}
function onCharaUp() {
    this.isdown = false;
    this.dragging = false;
    if (this.isOver){ this.children[1].texture = this.textures[1]; }
	else{ this.children[1].texture = this.textures[0]; } 
	this.isFalling = true;
}
function onCharaOver() {
    this.children[1].isOver = true;
    if (this.isdown) { return; }
    this.children[1].texture = this.textures[1];
}
function onCharaOut() {
    this.isOver = false;
    if (this.isdown) { return; }
    this.children[1].texture = this.textures[0];
}
function onCharaDragMove(event) {
    if (this.dragging) {
        this.x = event.data.getLocalPosition(this.parent).x + this.fixX;
        this.y = event.data.getLocalPosition(this.parent).y + this.fixY;
    }
}

</script>
</body>

